<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Views.Discounts.DiscountManagementPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:MyShop.Models.Discounts"
    mc:Ignorable="d">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0">
                <TextBlock Text="Discount Management" 
                          Style="{StaticResource TitleTextBlockStyle}"
                          Margin="0,0,0,8"/>
                <TextBlock Text="Manage your discount codes and promotions" 
                          Style="{StaticResource BodyTextBlockStyle}"
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>

            <Button Grid.Column="1" 
                   Content="Add Discount"
                   Style="{StaticResource AccentButtonStyle}"
                   Command="{x:Bind ViewModel.PrepareAddCommand}"
                   Click="AddButton_Click">
                <Button.KeyboardAccelerators>
                    <KeyboardAccelerator Key="N" Modifiers="Control"/>
                </Button.KeyboardAccelerators>
            </Button>
        </Grid>

        <!-- Status Bar -->
        <InfoBar Grid.Row="1"
                IsOpen="{x:Bind ViewModel.StatusMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                Message="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                Severity="Informational"
                Margin="0,0,0,16"/>

        <!-- Data Grid -->
        <Grid Grid.Row="2">
            <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                         Width="60" Height="60"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center"
                         Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"/>

            <ScrollViewer Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <ItemsControl ItemsSource="{x:Bind ViewModel.Discounts, Mode=OneWay}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:Discount">
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                   BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                   BorderThickness="1"
                                   CornerRadius="8"
                                   Padding="20"
                                   Margin="0,0,0,12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Main Content Row -->
                                    <Grid Grid.Row="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Left: Code and Description -->
                                        <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                            <TextBlock Text="{x:Bind Code}" 
                                                      FontWeight="SemiBold"
                                                      FontSize="18"
                                                      Margin="0,0,0,4"/>
                                            <TextBlock Text="{x:Bind Description}" 
                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Visibility="{x:Bind Description, Converter={StaticResource StringToVisibilityConverter}}"/>
                                        </StackPanel>

                                        <!-- Right: Status Badge -->
                                        <Border Grid.Column="1" 
                                               Padding="12,6"
                                               CornerRadius="4"
                                               VerticalAlignment="Top"
                                               Margin="16,0,0,0">
                                            <Border.Background>
                                                <SolidColorBrush Color="{x:Bind Status, Converter={StaticResource StatusToColorConverter}}"/>
                                            </Border.Background>
                                            <TextBlock Text="{x:Bind Status}" 
                                                      FontWeight="SemiBold"
                                                      FontSize="12"
                                                      Foreground="White"/>
                                        </Border>
                                    </Grid>

                                    <!-- Details and Actions Row -->
                                    <Grid Grid.Row="1" Margin="0,16,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Amount -->
                                        <StackPanel Grid.Column="0" Margin="0,0,24,0">
                                            <TextBlock Text="Amount" 
                                                      FontSize="11"
                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                      Margin="0,0,0,4"/>
                                            <TextBlock Text="{x:Bind FormattedAmount}" 
                                                      FontWeight="SemiBold"
                                                      FontSize="16"
                                                      Foreground="#6B46C1"/>
                                        </StackPanel>

                                        <!-- Usage -->
                                        <StackPanel Grid.Column="1" Margin="0,0,24,0">
                                            <TextBlock Text="Usage" 
                                                      FontSize="11"
                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                      Margin="0,0,0,4"/>
                                            <TextBlock Text="{x:Bind UsageDisplay}" 
                                                      FontWeight="SemiBold"
                                                      FontSize="14"/>
                                        </StackPanel>

                                        <!-- Valid Period -->
                                        <StackPanel Grid.Column="2" Margin="0,0,24,0">
                                            <TextBlock Text="Valid Period" 
                                                      FontSize="11"
                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                      Margin="0,0,0,4"/>
                                            <TextBlock FontSize="13">
                                                <Run Text="{x:Bind StartDate, Converter={StaticResource DateConverter}}"/>
                                                <Run Text=" - "/>
                                                <Run Text="{x:Bind EndDate, Converter={StaticResource DateConverter}}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <!-- Spacer -->
                                        <Border Grid.Column="3"/>

                                        <!-- Actions -->
                                        <StackPanel Grid.Column="4" 
                                                   Orientation="Horizontal" 
                                                   Spacing="8">

                                            <Button Content="Edit"
                                                   Style="{StaticResource SubtleButtonStyle}"
                                                   Click="EditButton_Click"
                                                   Tag="{x:Bind}"
                                                   Height="36"/>
                                            <Button Content="Delete"
                                                   Style="{StaticResource SubtleButtonStyle}"
                                                   Click="DeleteButton_Click"
                                                   Tag="{x:Bind}"
                                                   Height="36"/>
                                        </StackPanel>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Empty State -->
            <StackPanel HorizontalAlignment="Center" 
                       VerticalAlignment="Center"
                       Visibility="{x:Bind ViewModel.Discounts.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}}">
                <FontIcon Glyph="&#xE8F1;" FontSize="64" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                <TextBlock Text="No discount codes yet" 
                          FontSize="16" 
                          Margin="0,16,0,8"/>
                <TextBlock Text="Click 'Add Discount' to create your first code" 
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </Grid>

        <!-- Pagination Controls -->
        <Border Grid.Row="3" 
               Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
               BorderThickness="1"
               CornerRadius="8"
               Padding="16"
               Margin="0,16,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Page Size Selector -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" Margin="0,0,16,0">
                    <TextBlock Text="Số lượng/trang:" 
                              VerticalAlignment="Center"
                              Style="{StaticResource BodyTextBlockStyle}"/>
                    <ComboBox ItemsSource="{x:Bind ViewModel.PageSizeOptions}"
                             SelectedItem="{x:Bind ViewModel.PageSize, Mode=TwoWay}"
                             Width="80"
                             VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Page Info -->
                <TextBlock Grid.Column="1"
                          Text="{x:Bind ViewModel.PaginationInfo, Mode=OneWay}"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Center"
                          Style="{StaticResource BodyStrongTextBlockStyle}"/>

                <!-- Navigation Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <Button Command="{x:Bind ViewModel.GoToPreviousPageCommand}"
                           ToolTipService.ToolTip="Trang trước"
                           Width="100">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE76B;" FontSize="14"/>
                            <TextBlock Text="Trước"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Command="{x:Bind ViewModel.GoToNextPageCommand}"
                           ToolTipService.ToolTip="Trang sau"
                           Width="100">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Sau"/>
                            <FontIcon Glyph="&#xE76C;" FontSize="14"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Add/Edit Dialog -->
        <ContentDialog x:Name="DiscountDialog"
                      Title="Discount Details"
                      PrimaryButtonText="Save"
                      SecondaryButtonText="Cancel"
                      PrimaryButtonClick="DiscountDialog_PrimaryButtonClick"
                      SecondaryButtonClick="DiscountDialog_SecondaryButtonClick">
            <ScrollViewer>
                <StackPanel Spacing="16" MinWidth="400">
                    <!-- Code -->
                    <TextBox Header="Code *" 
                            PlaceholderText="e.g., SAVE50K, WELCOME10"
                            Text="{x:Bind ViewModel.EditCode, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            MaxLength="50"/>

                    <!-- Description -->
                    <TextBox Header="Description" 
                            PlaceholderText="Optional description"
                            Text="{x:Bind ViewModel.EditDescription, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            TextWrapping="Wrap"
                            AcceptsReturn="True"
                            Height="80"/>

                    <!-- Amount -->
                    <NumberBox Header="Discount Amount *" 
                              PlaceholderText="Enter amount"
                              Value="{x:Bind ViewModel.EditAmount, Mode=TwoWay}"
                              Minimum="1"
                              SpinButtonPlacementMode="Inline"/>

                    <!-- Start Date -->
                    <CalendarDatePicker Header="Start Date *"
                                       Date="{x:Bind ViewModel.EditStartDate, Mode=TwoWay}"/>

                    <!-- End Date -->
                    <CalendarDatePicker Header="End Date *"
                                       Date="{x:Bind ViewModel.EditEndDate, Mode=TwoWay}"/>

                    <!-- Usage Limit -->
                    <NumberBox Header="Usage Limit" 
                              PlaceholderText="Leave empty for unlimited"
                              Value="{x:Bind ViewModel.EditUsageLimit, Mode=TwoWay}"
                              Minimum="1"
                              SpinButtonPlacementMode="Inline"/>

                    <!-- Active Status -->
                    <ToggleSwitch Header="Active Status" 
                                 IsOn="{x:Bind ViewModel.EditIsActive, Mode=TwoWay}"
                                 OnContent="Active - Can be used"
                                 OffContent="Inactive - Disabled"/>

                    <TextBlock Text="* Required fields" 
                              FontSize="12" 
                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </ScrollViewer>
        </ContentDialog>
    </Grid>
</Page>
